<!DOCTYPE html>
<html lang="en">
<head>
<title>Sound Player</title>
	<link rel="stylesheet" href="./css/bootstrap.min.css">
	<style>
		table {
			background-color: white;
		}
		
		th, td {
			padding: 5px;
		}
		
		.main {
			padding: 10px;
			background-color: gray;
		}
		
		.glyphicon {
			padding-right: 7px;
		}
		
		.sceneTitle {
			font-family: Courier;
			font-weight: bold;
			background-color: #ffdb89;
			font-size: 20px;
		}
		
		.notes {
			font-family: Courier;
		}
		
		input[type=range][orient=vertical]
		{
			writing-mode: bt-lr; /* IE */
			-webkit-appearance: slider-vertical; /* WebKit */
			width: 5px;
			height: 100px;
			padding: 5px 5px;
		}
	</style>
	
	
	<script src="./js/jquery.min.js"></script>
	<script src="./data.js" ></script>
	<script type="text/javascript">
		
		var scenes = 1;
		var tracks = 1;
		
		$( document ).ready(function() {
			
			$("#btnNewScene").click(function() {
				createScene(scenes);
			});
			
			loadScenes();
			
			//var myBlob = new Blob(["This is my blob content"], {type : "text/plain"});
			//var myReader = new FileReader();
			////handler executed once reading(blob content referenced to a variable) from blob is finished. 
			//myReader.addEventListener("loadend", function(e){
			//	alert(e.srcElement.result);//prints a string
			//});
			////start the reading process.
			//myReader.readAsText(myBlob);
			
			//var client = new XMLHttpRequest();
			//client.open('GET', 'save.json');
			//client.onreadystatechange = function() {
			//	alert(client.responseText);
			//}
			//client.send();
			
			//$.getJSON("save.json", function(json) {
			//	console.log(json); // this will show the info it in firebug console
			//});
			
		});
		
		function loadScenes() {
			for(var s = 0; s < data.length; s++) {
				createScene(data[s].id);
				for(var t = 0; t < data[s].tracks.length; t++) {
					createTrack(
						data[s].id, 
						data[s].tracks[t].id, 
						data[s].tracks[t].filename, 
						data[s].tracks[t].volume,
						data[s].tracks[t].notes);
				}
			}
		}
		
		function exportScenes() {
			var exp = [];
			
			$('.scene').each(function(i, sobj) {
				var s = {};
				s.id = $(sobj).find(".sceneId").html();
				s.tracks = [];
				$('#Scene' + s.id + " .track").each(function(j, tobj) {
					var t = {};
					t.id = $(tobj).find(".trackId").html();
					t.filename = $(tobj).find(".txtFilename").val();
					t.volume = $(tobj).find(".volume").val();
					t.notes = $(tobj).find(".notes").val();
					s.tracks.push(t);
				});
				exp.push(s);
			});
			$("#exportTextArea").text(JSON.stringify(exp));
		}
		
		function getFilePath(){
			$('input[type=file]').change(function () {
				var filePath=$('#fileUpload').val(); 
				console.log(filePath);
				$("#txtFilename1").val(filePath);
			});
		}
		
		function createScene(sceneId) {
			var row = $('<tr></tr>').append(
				$('<td id="Scene' + sceneId + '" class="scene"></td>').append(
					$("#sceneTemplate").html()
				)
			);
			$("#allScenes").append(row);
			
			// set vars
			$("#Scene" + sceneId + " .sceneId").html(sceneId);
			
			// set listeners
			$("#Scene" + sceneId + " .sceneTitle").text("SCENE " + sceneId);
			$("#Scene" + sceneId + " .btnNewTrack").click(function() {
				console.log("createTrack(" + sceneId + ", " + tracks + ")");
				createTrack(sceneId, tracks);
			});
			
			scenes = parseInt(sceneId) + 1;
		}
		
		function createTrack(sceneId, trackId, defaultFilename="", defaultVolume=50, defaultNotes="") {
			
			var table = $('<table></table>').append(
				$('<tbody></tbody>').append(
					$('<tr></tr>').append(
						$('<td id="Track' + trackId + '" class="track"></td>').append(
							$("#trackTemplate").html()
						)
					)
				)
			);
			
			$("#Scene" + sceneId + " .trackTable").append(table);
			
			// set vars
			$("#Track" + trackId + " .trackId").html(trackId);
			
			// set listeners
			$("#Track" + trackId + " .fileUpload").change(function () {
				var filePath=$("#Track" + trackId + " .fileUpload").val();
				if (filePath) {
					//parse the filename
					var startIndex = (filePath.indexOf('\\') >= 0 ? filePath.lastIndexOf('\\') : filePath.lastIndexOf('/'));
					var filename = filePath.substring(startIndex);
					if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
						filename = filename.substring(1);
					}
					var txtTrackName = $("#Track" + trackId + " .txtFilename");
					txtTrackName.val(filename);
					txtTrackName.trigger("change");
				}
			});
			$("#Track" + trackId + " .txtFilename").change(function() {
				var file = $("#txtFilePath").val() + $(this).val();
				console.log('loading ' + file + '...');
				$("#Track" + trackId + " .audMp3Src").attr("src",file);
				$("#Track" + trackId + " .audOggSrc").attr("src",file);
				$("#Track" + trackId + " .audio").attr("src",file);
			});
			$("#Track" + trackId + " .volume").change(function() {
				$("#Track" + trackId + " .audio").prop("volume", $(this).val() / 100);
			});
			
			// set defaults
			if(defaultFilename !== "") {
				var txtTrackName = $("#Track" + trackId + " .txtFilename");
				txtTrackName.val(defaultFilename);
				txtTrackName.trigger("change");
			}
			var volSlider = $("#Track" + trackId + " .volume");
			volSlider.val(defaultVolume);
			volSlider.trigger("change");
			$("#Track" + trackId + " .notes").text(defaultNotes);
			
			tracks = parseInt(trackId) + 1;
		}
		
		function removeTrack(sceneId, trackId) {
			if(trackId >= 0) {
				$("#trackTable" + sceneId).remove("track" + trackId);
			}
		}
		
		function loadSource(id) {
			var file = $("#txtFilePath").val() + $("#txtFilename" + id).val().name;
			console.log('loading ' + file + '...');
			$("#audOggSrc" + id).attr("src",file);
			document.getElementById('audio' + id).load();
		}
		
		function saveData() {
			download(data, "save.json", "application/json");
		}
		
		// Function to download data to a file
		function download(data, filename, type) {
			var file = new Blob([data], {type: type});
			if (window.navigator.msSaveOrOpenBlob) // IE10+
				window.navigator.msSaveOrOpenBlob(file, filename);
			else { // Others
				var a = document.createElement("a"),
						url = URL.createObjectURL(file);
				a.href = url;
				a.download = filename;
				document.body.appendChild(a);
				a.click();
				setTimeout(function() {
					document.body.removeChild(a);
					window.URL.revokeObjectURL(url);  
				}, 0); 
			}
		}
	</script>
	
</head>
<body class="main">

	<!-- Global table -->
	<table>
		<tr>
			<td><button id="btnExport" onclick="exportScenes()" type="button">Export</button></td>
			<td>
				<textarea id="exportTextArea" readonly></textarea>
			</td>
			<td>
				<label for="txtFilePath">Sound Files Path</label>
				<input type="text" name="filePath" id="txtFilePath" value="./sounds/">
			</td>
			
		</tr>
		<tr>
			<td>
				<button id="btnNewScene" type="button" style="font-size: 15px;">
					<span class="glyphicon glyphicon-plus"></span>Create New Scene
				</button>
			</td>
		</tr>
	</table>
	
	<br/>
	
	
	
	<!-- Scenes table -->
	<table id="allScenes">
		<tbody>
			
		</tbody>
	</table>
	
</body>

<div id="sceneTemplate" style="display:none;">
	<table>
		<tbody>
			<tr>
				<td class="sceneId" style="display:none;"></td>
			</tr>
			<tr>
				<td><input type="checkbox"  class="sceneCheckbox"></td>
				<td class="sceneTitle"></td>
			</tr>
			<tr>
			<td></td>
				<td>
					<!-- Scene Buttons -->
					<table>
						<tbody>
							<tr>
								<td>
									<button class="btnNewTrack" type="button" style="font-size: 15px;">
										<span class="glyphicon glyphicon-music"></span>
										Create New Track
									</button>
								</td>
								<!--<td><button class="btnRemoveTracks" type="button">Remove New Track(s)</button></td>-->
								<!--<td><button class="btnPlayAll" type="button">Play All</button></td>-->
							</tr>
						</tbody>
					</table>
				</td>
			</tr>
			<tr>
				<td></td>
				<td class="trackTable">
				</td>
			</tr>
		</tbody>
	</table>
	<br/>
</div>

<div id="trackTemplate" style="display:none;">
	<table>
		<tbody>
			<tr>
				<td class="trackId" style="display:none;"></td>
			</tr>
			<tr>
				<td><input type="checkbox"  class="trackCheckbox"></td>
				<td>
					<audio class="audio" controls>
						<source class="audMp3Src" src="" type="audio/mp3">
						<source class="audOggSrc" src="" type="audio/ogg">
						Your browser does not support the audio tag.
					</audio>
				</td>
				<td rowspan="2">
					<div class="slidecontainer">
						<input type="range" orient="vertical" min="0" max="100" value="100" class="volume">
					</div>
				</td>
				
				<td rowspan="2">
					<textarea class="notes" rows="4" cols="50">
					</textarea>
				</td>
				<!--<td>
					<button class="btnPlayTrack" type="button">Play</button>
				</td>-->
			</tr>
			<tr>
				<td></td>
				<td>
					<span><input class="txtFilename" value=""></span>
					<input type="file" class="fileUpload">
				</td>
			</tr>
		</tbody>
	</table>
</div>

<!--
	<audio id="audio1" controls>
		<source src="./sounds/thunder1.ogg" type="audio/ogg">
		Your browser does not support the audio tag.
	</audio>
	<audio id="audio2" controls>
		<source src="./sounds/thunder2.ogg" type="audio/ogg">
		Your browser does not support the audio tag.
	</audio>
	<audio id="audio3" controls>
		<source src="./sounds/gentle_rain.ogg" type="audio/ogg">
		Your browser does not support the audio tag.
	</audio>-->
	
</html>